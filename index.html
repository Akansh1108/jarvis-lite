<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jarvis Lite — Voice OS (Diwali Edition)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0b0f1a" />
  <style>
    :root{
      --bg:#070a12; --panel:#0b0f1a; --ink:#c8d3f5; --muted:#8b9cc8; --accent:#a78bfa; --accent2:#22d3ee; --success:#34d399; --danger:#fb7185;
      --glow:0 0 30px rgba(167,139,250,.35), 0 0 60px rgba(34,211,238,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 800px at 80% -10%,rgba(167,139,250,.08),transparent),
                 radial-gradient(1000px 600px at 10% 110%,rgba(34,211,238,.08),transparent),
                 var(--bg);
      color:var(--ink)}
    header{padding:24px 20px 0;display:flex;align-items:center;gap:12px;justify-content:center}
    .logo{width:14px;height:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;box-shadow:var(--glow)}
    h1{font-size:18px;font-weight:800;letter-spacing:.4px;margin:0}
    .wrap{max-width:980px;margin:18px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px); border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .hero{padding:20px}
    .voicebar{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:14px}
    button{all:unset;background:linear-gradient(135deg,var(--accent),var(--accent2));
      padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;color:#08101f;box-shadow:var(--glow)}
    button.secondary{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.08);box-shadow:none}
    input,textarea{width:100%;background:transparent;border:none;outline:none;color:var(--ink)}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .card{padding:12px;border-radius:12px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06)}
    .k{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .out{min-height:140px;white-space:pre-wrap}
    .right{padding:16px;display:flex;flex-direction:column;gap:12px}
    .log{height:220px;overflow:auto;padding:10px;background:rgba(255,255,255,.02);border-radius:10px;border:1px solid rgba(255,255,255,.06)}
    .list li{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
    .list li:last-child{border-bottom:0}
    .tag{font-size:11px;color:#08101f;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:2px 8px;border-radius:999px}
    .pill{font-size:11px;color:var(--muted);padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08)}
    canvas{width:100%;height:220px;background:radial-gradient(600px 400px at 50% 100%,rgba(167,139,250,.08),transparent)}
    footer{margin-top:16px;font-size:12px;color:var(--muted);text-align:center}
    @media(max-width:980px){.grid{grid-template-columns:1fr}.cards{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <h1>Jarvis Lite — Voice OS <span class="small">(Diwali Edition)</span></h1>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="panel hero">
        <div class="voicebar">
          <button id="micBtn">🎤 Start</button>
          <input id="cmd" placeholder="Try: ‘make a diwali wish card for Resham’, ‘create QR for https://ctrlaltparty.in’, ‘add task buy diyas 7pm’" />
          <button class="secondary" id="runBtn">Run</button>
        </div>

        <!-- Magic-link sign-in -->
        <div style="display:flex;gap:8px;margin:10px 0;align-items:center">
          <input id="email" placeholder="Enter email for magic link" />
          <button class="secondary" onclick="window.jarvisSignIn()">Sign in</button>
          <button class="secondary" onclick="window.jarvisSignOut()" title="Sign out">Sign out</button>
          <span id="authStatus" class="small"></span>
        </div>

        <div class="small" style="margin-top:4px">Zero backend. Browser-only. Optional DB & Auth via Supabase.</div>

        <div class="cards">
          <div class="card">
            <div class="k">Output</div>
            <div id="out" class="out"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="secondary" id="speakBtn">🔊 Speak</button>
              <button class="secondary" id="copyBtn">📋 Copy</button>
            </div>
          </div>

          <div class="card">
            <div class="k">Diwali Canvas</div>
            <canvas id="canvas" width="700" height="220"></canvas>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="secondary" id="saveImgBtn">🪔 Save Card</button>
              <button class="secondary" id="shareBtn">📤 Share</button>
            </div>
          </div>

          <div class="card">
            <div class="k">QR</div>
            <canvas id="qrc" width="220" height="220"></canvas>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="qrText" placeholder="Text or URL for QR"/>
              <button class="secondary" id="qrBtn">Generate</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="panel right">
        <div>
          <div class="k">Tasks</div>
          <ul id="tasks" class="list"></ul>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="taskIn" placeholder="Add task…">
            <button class="secondary" id="addTask">Add</button>
          </div>
        </div>
        <div>
          <div class="k">Command Log</div>
          <div id="log" class="log"></div>
        </div>
        <div>
          <div class="k">Quick Commands</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <span class="pill">make a diwali wish card for Resham</span>
            <span class="pill">create QR for https://ctrlaltparty.in</span>
            <span class="pill">add task buy diyas 7pm</span>
            <span class="pill">clear canvas</span>
          </div>
        </div>
      </aside>
    </div>
    <footer>Built with Web APIs — Speech Recognition, Speech Synthesis, Canvas, LocalStorage, Web Share — plus Supabase (Free). Host on Vercel for ₹0.</footer>
  </div>

  <script>
    // === Utilities ===
    const $ = (s)=>document.querySelector(s);
    const out = $('#out'), log = $('#log'), cmd = $('#cmd');
    const canvas = $('#canvas'), ctx = canvas.getContext('2d');
    const qrc = $('#qrc'), qctx = qrc.getContext('2d');
    const tasksEl = $('#tasks');

    function addLog(text){
      const t = new Date().toLocaleTimeString();
      log.innerHTML = `<div><span class="tag">${t}</span> ${text}</div>` + log.innerHTML;
    }
    function speak(text){
      if(!('speechSynthesis' in window)) return alert('Speech Synthesis not supported');
      const u = new SpeechSynthesisUtterance(text); u.rate = 1.02; u.pitch=1.0;
      window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }

    // === Local tasks (fallback) ===
    function loadTasksLocal(){ return JSON.parse(localStorage.getItem('jarvis_tasks')||'[]'); }
    function saveTasksLocal(list){ localStorage.setItem('jarvis_tasks', JSON.stringify(list)); }
    function renderTasks(){
      const list = loadTasksLocal();
      tasksEl.innerHTML = list.map((t,i)=>`<li><span>${t.text}</span><span><button class="secondary" data-i="${i}">✔</button></span></li>`).join('');
    }
    tasksEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const i = +btn.dataset.i; const list = loadTasksLocal();
      list.splice(i,1); saveTasksLocal(list); renderTasks();
    });

    // === Canvas ===
    function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    function fireworks(){
      clearCanvas();
      const particles = Array.from({length: 80}).map(()=>({
        x: canvas.width/2, y: canvas.height, vx:(Math.random()-0.5)*4, vy: -Math.random()*6-3, life: Math.random()*60+40
      }));
      let frame = 0;
      const anim = ()=>{
        frame++; ctx.fillStyle='rgba(7,10,18,.25)'; ctx.fillRect(0,0,canvas.width,canvas.height);
        particles.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.vy+=0.08; p.life--;
          const hue = 250 + Math.sin((p.x+p.y+frame)/20)*60;
          ctx.fillStyle = `hsla(${hue},90%,70%,.9)`;
          ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
        });
        if(frame<180) requestAnimationFrame(anim);
      };
      anim();
    }
    function drawWishCard(text){
      clearCanvas();
      const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      grad.addColorStop(0,'#0b0f1a'); grad.addColorStop(1,'#121735');
      ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);
      fireworks();
      ctx.fillStyle='#a78bfa'; ctx.font='700 26px Inter'; ctx.fillText('✨ Happy Diwali ✨', 22, 44);
      ctx.fillStyle='#c8d3f5'; ctx.font='600 18px Inter';
      wrapText(ctx, text, 22, 80, canvas.width-44, 26);
      ctx.fillStyle='#22d3ee'; ctx.font='600 14px Inter';
      ctx.fillText('— from Akansh & Resham', 22, canvas.height-18);
    }
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' '); let line='';
      for(let n=0; n<words.length; n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if(metrics.width>maxWidth && n>0){ ctx.fillText(line, x, y); line = words[n] + ' '; y += lineHeight; }
        else { line = testLine; }
      }
      ctx.fillText(line, x, y);
    }

    // === Artistic pseudo-QR (zero deps) ===
    const QREncode = (()=>({
      draw:(text, ctx)=>{
        const W=220,H=220; ctx.clearRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#000';
        const seed = text.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
        const n=21; const cell=Math.floor(W/n);
        for(let y=0;y<n;y++){ for(let x=0;x<n;x++){
          const v = ((x*31 + y*17 + seed)%7)<3; if(v) ctx.fillRect(x*cell, y*cell, cell-1, cell-1);
        }}  // finder patterns
        ctx.fillStyle='#fff'; ctx.fillRect(0,0,cell*7,cell*7); ctx.fillRect((n-7)*cell,0,cell*7,cell*7); ctx.fillRect(0,(n-7)*cell,cell*7,cell*7);
        ctx.fillStyle='#000'; ctx.fillRect(cell,cell,cell*5,cell*5); ctx.clearRect(cell*2,cell*2,cell*3,cell*3);
        ctx.fillRect((n-6)*cell,cell,cell*5,cell*5); ctx.clearRect((n-5)*cell+cell,(cell*2),cell*3,cell*3);
        ctx.fillRect(cell,(n-6)*cell,cell*5,cell*5); ctx.clearRect(cell*2,(n-5)*cell,cell*3,cell*3);
        ctx.fillStyle='#000'; ctx.font='10px Inter'; ctx.fillText('QR (artistic)', 8, H-6);
      }
    }))();
    function makeQR(text){ QREncode.draw(text, qctx); addLog(`QR generated for: ${text}`); }

    // === Commands ===
    function runCommand(raw){
      const s = raw.trim(); if(!s) return;
      addLog(`Command: ${s}`);
      const low = s.toLowerCase();

      if(low.startsWith('add task ')){
        const v = s.slice(9).trim();
        addTaskSmart(v); return;
      }
      if(low.startsWith('create qr for ')){
        const v = s.slice('create qr for '.length).trim(); $('#qrText').value=v; makeQR(v); out.textContent = `QR created for: ${v}`; return;
      }
      if(low.startsWith('make a diwali wish card for ')){
        const name = s.split('for ')[1]||'you';
        const msg = `Wishing you boundless light, health, and momentum. ${name}, may your next 365 days glow with wins.`;
        drawWishCard(msg); out.textContent = `Wish card generated for ${name}. Click ‘Save Card’.`; speak(`Happy Diwali, ${name}!`);
        saveCurrentWish(name, msg); return;
      }
      if(low === 'clear canvas'){ clearCanvas(); out.textContent = 'Canvas cleared.'; return; }

      out.textContent = s; fireworks();
    }
    $('#runBtn').onclick = ()=> runCommand(cmd.value);

    // Mic
    let rec; $('#micBtn').onclick = ()=>{
      if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
        alert('Speech Recognition not supported in this browser'); return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition; rec = new SR();
      rec.lang='en-IN'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult=(e)=>{ const text = e.results[0][0].transcript; cmd.value=text; runCommand(text); };
      rec.onstart=()=>{ $('#micBtn').textContent='🎙️ Listening…'; };
      rec.onend =()=>{ $('#micBtn').textContent='🎤 Start'; };
      rec.start();
    };

    // Buttons
    $('#copyBtn').onclick = ()=>{ navigator.clipboard.writeText(out.textContent||''); addLog('Output copied'); };
    $('#speakBtn').onclick = ()=> speak(out.textContent||'');
    $('#qrBtn').onclick = ()=> makeQR($('#qrText').value||'Hello, world');
    $('#saveImgBtn').onclick = ()=>{
      const a = document.createElement('a'); a.download='diwali-card.png'; a.href = canvas.toDataURL('image/png'); a.click(); addLog('Card saved');
    };
    $('#shareBtn').onclick = async ()=>{
      const blob = await new Promise(res=>canvas.toBlob(res,'image/png'));
      if(navigator.share && blob){
        const file = new File([blob],'diwali-card.png',{type:'image/png'});
        try{ await navigator.share({title:'Diwali Card', files:[file], text:'Happy Diwali!'}); addLog('Shared via Web Share API'); }
        catch(e){ addLog('Share cancelled'); }
      } else { addLog('Web Share API not supported'); }
    };
    document.querySelectorAll('.pill').forEach(p=>p.addEventListener('click',()=>{ cmd.value=p.textContent; runCommand(p.textContent); }));

    // Init
    renderTasks(); fireworks();

    async function addTaskSmart(v){
      try{
        const ok = await window.jarvisSaveTask(v);
        if(ok){ addLog(`Task saved to DB: ${v}`); }
        else { throw new Error('DB save failed'); }
      }catch(e){
        const list = loadTasksLocal(); list.unshift({text:v, ts:Date.now()}); saveTasksLocal(list);
        addLog(`Task saved locally: ${v}`);
      }
      $('#taskIn').value=''; renderTasks(); out.textContent = `Task added: ${v}`;
    }
    async function saveCurrentWish(name, msg){
      try{
        const dataUrl = canvas.toDataURL('image/png');
        const ok = await window.jarvisSaveWish(name, msg, dataUrl);
        if(ok) addLog(`Wish saved to DB for ${name}`);
        else addLog('Saved card locally only (not signed in)');
      }catch(e){ addLog('Saved card locally only (not signed in)'); }
    }
  </script>

  <!-- Supabase wiring (client-only, safe for anon key) -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL  = 'https://tqkixrssdwucgmgubbpm.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxa2l4cnNzZHd1Y2dtZ3ViYnBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NDkwMzgsImV4cCI6MjA3NjQyNTAzOH0.rcCNkdNhpvX34Dwg105QZ-BeaJ1oy2Wvp4MhY6akwcA';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // Global sign-in / sign-out (used by inline onclick)
    window.jarvisSignIn = async () => {
      try {
        const emailInput = document.getElementById('email');
        const email = (emailInput?.value || '').trim();
        if (!email) return alert('Enter an email first!');
        const { error } = await supabase.auth.signInWithOtp({ email });
        alert(error ? `Sign-in error: ${error.message}` : 'Magic link sent! Check your inbox.');
      } catch (e) {
        alert(`Sign-in failed: ${e.message}`);
      }
    };
    window.jarvisSignOut = async () => {
      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        alert('Signed out successfully.');
        updateStatus();
      } catch (e) {
        alert(`Sign-out failed: ${e.message}`);
      }
    };

    // Save helpers
    window.jarvisSaveTask = async (text) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return false;
      const { error } = await supabase.from('tasks').insert({ user_id: user.id, text });
      if (error) console.error(error);
      return !error;
    };
    window.jarvisSaveWish = async (name, message, image_data_url = null) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return false;
      const { error } = await supabase.from('wishes').insert({ user_id: user.id, name, message, image_data_url });
      if (error) console.error(error);
      return !error;
    };

    // Auth status label
    async function updateStatus() {
      const s = document.getElementById('authStatus');
      if (!s) return;
      const { data: { user } } = await supabase.auth.getUser();
      s.textContent = user ? 'Signed in ✅' : 'Not signed in ❌';
    }
    updateStatus();
    supabase.auth.onAuthStateChange(() => updateStatus());
  </script>
</body>
</html>
